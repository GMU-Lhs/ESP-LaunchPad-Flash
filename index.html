<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>ESP32-C3 USB 在线烧录</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>

<body style="
  font-family: Arial, Helvetica, sans-serif;
  text-align: center;
  padding-top: 50px;
  background-color: #f7f7f7;
">

  <h2>ESP32-C3 USB 在线烧录</h2>

  <p>
    请使用 <b>Chrome / Edge</b> 浏览器<br>
    使用 <b>USB 数据线</b> 连接 ESP32-C3
  </p>

  <!-- ESP Launchpad 跳转入口 -->
  <a
    href="https://esp.eterill.xyz/?flashConfigURL=https://GMU-lhs.github.io/ESP-LaunchPad-Flash/config.toml"
    target="_blank"
    rel="noopener"
  >
    <img
      src="https://esp.eterill.xyz/assets/try_with_launchpad.png"
      width="260"
      alt="ESP Launchpad 一键烧录"
    >
  </a>

  <p style="margin-top: 30px; color: #666; font-size: 14px;">
    点击按钮后，选择 USB 设备即可开始烧录<br>
    无需安装任何软件
  </p>

  <!-- 分割线 -->
  <hr style="margin:40px auto; max-width:600px;">

  <h3>ESP32-C3 USB 串口通信</h3>
  <p style="color:#666;font-size:14px;">
    烧录完成后，点击下方按钮连接 ESP32-C3 串口（Web Serial）
  </p>

  <div style="max-width:720px;margin:0 auto;background:#fff;padding:16px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.08);text-align:left;">

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;align-items:center;">
      <button id="connect">连接串口</button>
      <button id="disconnect" disabled>断开</button>
      <button id="clear">清屏</button>

      <label style="margin-left:auto;display:flex;gap:6px;align-items:center;">
        波特率：
        <select id="baud">
          <option value="115200">115200</option>
          <option value="921600">921600</option>
          <option value="9600">9600</option>
        </select>
      </label>
    </div>

    <pre id="log" style="height:260px;overflow:auto;background:#0d1117;color:#d1e7ff;padding:10px;border-radius:8px;margin:0;white-space:pre-wrap;"></pre>

    <div style="display:flex;gap:10px;margin-top:10px;">
      <input id="input" placeholder="输入内容，回车发送" style="flex:1;padding:8px;border-radius:8px;border:1px solid #ddd;">
      <button id="send" disabled>发送</button>
    </div>
  </div>

<script>
let port, reader, writer;

const elLog = document.getElementById("log");
const btnConnect = document.getElementById("connect");
const btnDisconnect = document.getElementById("disconnect");
const btnClear = document.getElementById("clear");
const selBaud = document.getElementById("baud");
const input = document.getElementById("input");
const btnSend = document.getElementById("send");

let lineBuf = "";           // 用来拼接不完整的一行
let outQueue = [];          // 输出队列（提升性能）
let flushTimer = null;
const MAX_LOG_CHARS = 200000; // 日志太长会卡，做个上限

function ts() {
  const d = new Date();
  const hh = String(d.getHours()).padStart(2, "0");
  const mm = String(d.getMinutes()).padStart(2, "0");
  const ss = String(d.getSeconds()).padStart(2, "0");
  const ms = String(d.getMilliseconds()).padStart(3, "0");
  return `${hh}:${mm}:${ss}.${ms}`;
}

// 把文本放进队列，定时批量刷新 DOM（避免卡顿/“像丢数据”）
function enqueue(text) {
  outQueue.push(text);
  if (!flushTimer) {
    flushTimer = setTimeout(() => {
      flushTimer = null;
      const chunk = outQueue.join("");
      outQueue = [];
      elLog.textContent += chunk;

      // 限制日志长度，避免越跑越卡
      if (elLog.textContent.length > MAX_LOG_CHARS) {
        elLog.textContent = elLog.textContent.slice(-MAX_LOG_CHARS);
      }

      elLog.scrollTop = elLog.scrollHeight;
    }, 50);
  }
}

function setUi(connected) {
  btnConnect.disabled = connected;
  btnDisconnect.disabled = !connected;
  btnSend.disabled = !connected;
}

async function safeClose() {
  try { await reader?.cancel(); } catch {}
  try { reader?.releaseLock(); } catch {}
  try { writer?.releaseLock(); } catch {}
  try { await port?.close(); } catch {}
  reader = null; writer = null; port = null;
}

btnClear.onclick = () => { elLog.textContent = ""; };

btnConnect.onclick = async () => {
  try {
    if (!("serial" in navigator)) {
      alert("当前浏览器不支持 Web Serial，请用桌面版 Chrome / Edge。");
      return;
    }

    // 让用户选择串口（注意：如果选错口/被占用会 open 失败）
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: Number(selBaud.value) });

    writer = port.writable.getWriter();

    // 读：Uint8Array -> string
    const decoder = new TextDecoderStream();
    const readableClosed = port.readable.pipeTo(decoder.writable);
    reader = decoder.readable.getReader();

    enqueue(`[${ts()}] 已连接串口 baud=${selBaud.value}\n`);
    setUi(true);

    // 读取循环（按行加时间戳）
    while (true) {
      const { value, done } = await reader.read();
      if (done) break;
      if (!value) continue;

      lineBuf += value;
      lineBuf = lineBuf.replace(/\r\n/g, "\n"); // 统一换行

      const lines = lineBuf.split("\n");
      lineBuf = lines.pop(); // 最后一段可能是不完整的一行，留着下次拼

      for (const line of lines) {
        enqueue(`[${ts()}] ${line}\n`);
      }
    }

    await readableClosed.catch(() => {});
  } catch (e) {
    enqueue(`[${ts()}] 连接失败：${e.message}\n`);
    await safeClose();
    setUi(false);
  }
};

btnDisconnect.onclick = async () => {
  await safeClose();
  enqueue(`[${ts()}] 已断开\n`);
  setUi(false);
};

btnSend.onclick = async () => {
  if (!writer) return;
  const text = input.value;
  input.value = "";
  // 发送也加时间戳回显（可选）
  enqueue(`[${ts()}] >> ${text}\n`);
  await writer.write(new TextEncoder().encode(text + "\n"));
};

input.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    btnSend.click();
  }
});

// 设备被拔掉/重启时，自动提示
navigator.serial?.addEventListener("disconnect", async () => {
  enqueue(`[${ts()}] 设备断开（可能是拔插/重启/烧录后重新枚举）\n`);
  await safeClose();
  setUi(false);
});
</script>


</body>
</html>

